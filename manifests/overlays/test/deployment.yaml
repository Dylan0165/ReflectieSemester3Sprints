apiVersion: apps/v1
kind: Deployment
metadata:
  name: reflectie-website
  labels:
    app: reflectie-website
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reflectie-website
  template:
    metadata:
      labels:
        app: reflectie-website
    spec:
      volumes:
        - name: site
          emptyDir: {}
        - name: nginx-conf
          configMap:
            name: reflectie-nginx-conf
            items:
              - key: default.conf
                path: default.conf
      initContainers:
        - name: fetch-static
          image: alpine:3.20
          env:
            - name: ZIP_URL
              value: "https://codeload.github.com/dylan0165/ReflectieSemester3Sprints/zip/refs/heads/deploy-static"
          command: ["/bin/sh","-c"]
          args:
            - |
              set -eux
              apk add --no-cache curl unzip
              mkdir -p /work
              curl -L "$ZIP_URL" -o /work/site.zip
              unzip /work/site.zip -d /work
              SRC_DIR=$(find /work -maxdepth 1 -type d -name "*-deploy-static" | head -n1)
              cp -R "$SRC_DIR"/* /var/www/
          volumeMounts:
            - name: site
              mountPath: /var/www
      containers:
        - name: nginx
          image: nginx:stable-alpine
          ports:
            - name: http
              containerPort: 80
          volumeMounts:
            - name: site
              mountPath: /usr/share/nginx/html
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d